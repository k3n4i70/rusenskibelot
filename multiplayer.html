<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Белот Русе P2P (Демо v7.0 - 4 Players PeerJS)</title>
    <style>
        /* --- Основни Стилове --- */
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; background-color: #f0f0f0; margin: 0; padding: 10px; min-height: 100vh; box-sizing: border-box; }
        .game-container { background-color: #2a6a2a; border: 5px solid #5d3a1a; border-radius: 10px; padding: 15px; width: 95%; max-width: 800px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.5); position: relative; aspect-ratio: 4 / 3; display: flex; flex-direction: column; justify-content: space-between; overflow: hidden; }
        .persistent-trump { position: absolute; top: 10px; right: 10px; background-color: rgba(0, 0, 0, 0.6); color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.9em; z-index: 50; text-align: right; max-width: 150px; }
        .persistent-trump .suit { font-size: 1.3em; font-weight: bold; }
        .persistent-trump .suit.spades, .persistent-trump .suit.clubs { color: white; text-shadow: 1px 1px 1px black; }
        .persistent-trump .suit.hearts, .persistent-trump .suit.diamonds { color: #ffcccc; text-shadow: 1px 1px 1px darkred; }
        .player-area { display: flex; align-items: center; position: absolute; min-width: 80px; min-height: 70px; background: rgba(255, 255, 255, 0.1); border-radius: 5px; padding: 5px; transition: box-shadow 0.3s ease; z-index: 20; }
        .player-area.current-player { box-shadow: 0 0 15px 5px yellow; }
        .player-south { bottom: 10px; left: 50%; transform: translateX(-50%); flex-direction: column; align-items: center; width: 80%; }
        .player-west { left: 10px; top: 50%; transform: translateY(-50%); flex-direction: column; align-items: flex-start; }
        .player-north { top: 10px; left: 50%; transform: translateX(-50%); flex-direction: column-reverse; align-items: center; }
        .player-east { right: 10px; top: 50%; transform: translateY(-50%); flex-direction: column; align-items: flex-end; }
        .player-name { font-weight: bold; color: white; margin-bottom: 5px; font-size: 0.9em; text-shadow: 1px 1px 2px black; }
        .hand { display: flex; flex-wrap: wrap; gap: 2px; justify-content: center; min-height: 50px; }
        .player-west .hand, .player-east .hand { flex-direction: column; gap: 1px; }
        .card { border: 1px solid black; border-radius: 5px; padding: 5px; min-width: 40px; min-height: 60px; background-color: white; display: inline-flex; flex-direction: column; justify-content: space-between; align-items: center; font-size: 1em; cursor: default; box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3); position: relative; user-select: none; transition: transform 0.2s ease, box-shadow 0.2s ease, border 0.2s ease; }
        .card.playable { cursor: pointer; border: 2px solid yellow; box-shadow: 0 0 10px yellow; }
        .card.playable:hover { transform: translateY(-10px); }
        .card span { display: block; text-align: center; font-weight: bold; }
        .card .rank { font-size: 1.2em; }
        .card .suit { font-size: 1.5em; }
        .card.spades .suit, .card.clubs .suit { color: black; }
        .card.hearts .suit, .card.diamonds .suit { color: red; }
        .card.hidden { background-color: #b0b0b0; background-image: repeating-linear-gradient(45deg, #a0a0a0, #a0a0a0 5px, #b0b0b0 5px, #b0b0b0 10px ); color: transparent; box-shadow: none; border: 1px solid #777; }
        .player-west .card.hidden, .player-east .card.hidden { min-width: 20px; min-height: 60px; }
        .player-north .card.hidden { min-width: 40px; min-height: 30px; }
        .trick-area { position: absolute; top: 20%; left: 15%; width: 70%; height: 60%; pointer-events: none; z-index: 10; }
        .trick-card-slot { position: absolute; transform: translate(-50%, -50%); }
        .trick-card-slot.player-S { top: 75%; left: 50%; }
        .trick-card-slot.player-W { top: 50%; left: 25%; }
        .trick-card-slot.player-N { top: 25%; left: 50%; }
        .trick-card-slot.player-E { top: 50%; left: 75%; }
        .controls-area { position: absolute; bottom: calc(10px + 70px + 10px); left: 50%; transform: translateX(-50%); background: rgba(255, 255, 255, 0.8); padding: 10px; border-radius: 5px; text-align: center; z-index: 60; display: none; }
        .controls-area.visible { display: block; }
        .controls-area button { padding: 8px 15px; margin: 5px; font-size: 1em; cursor: pointer; border: none; border-radius: 5px; background-color: #4CAF50; color: white; transition: background-color 0.2s ease; }
        .controls-area button:hover:not(:disabled) { background-color: #45a049; }
        .controls-area button:disabled { background-color: #cccccc; cursor: not-allowed; }
        .controls-area button.pass { background-color: #f44336; }
        .controls-area button.pass:hover:not(:disabled) { background-color: #da190b; }
        .controls-area button.bid { background-color: #2196F3; }
        .controls-area button.bid:hover:not(:disabled) { background-color: #0b7dda; }
        .announcements, .messages, .score-board { margin-top: 10px; background: rgba(255, 255, 255, 0.8); padding: 10px; border-radius: 5px; text-align: center; width: 90%; max-width: 600px; }
        .announcements { min-height: 50px; text-align: left; }
        .announcements p { text-align: center; margin-bottom: 5px; font-weight: bold; }
        .declared-announcement-item { margin: 2px 0; padding: 3px; border-bottom: 1px dotted #ccc; font-size: 0.9em; }
        .declared-announcement-item:last-child { border-bottom: none; }
        .messages { min-height: 40px; font-weight: bold; color: #333; }
        .score-board { font-size: 1.1em; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); padding-top: 60px; }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; text-align: center; }
        .modal-content h3 { margin-top: 0; }
        .modal-announcement-list label { display: block; margin: 8px 0; cursor: pointer; padding: 5px; border: 1px solid #eee; border-radius: 4px; }
        .modal-announcement-list label:hover { background-color: #f0f0f0; }
        .modal-announcement-list input[type="checkbox"] { margin-right: 10px; }
        .modal-close-btn { margin-top: 15px; padding: 10px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; }
        .modal-close-btn:hover { background-color: #45a049; }

        .connection-setup { border: 1px solid #ccc; padding: 15px; margin: 20px auto; width: 90%; max-width: 600px; background-color: #f9f9f9; border-radius: 8px; text-align: center; }
        .connection-setup h2 { margin-top: 0; }
        .connection-setup input[type="text"],
        .connection-setup button { padding: 8px; margin: 5px; border-radius: 4px; border: 1px solid #ddd; }
        .connection-setup button { background-color: #5cb85c; color: white; cursor: pointer; }
        .connection-setup button:hover { background-color: #4cae4c; }
        #host-panel, #guest-panel { margin-top: 15px; padding: 10px; border: 1px dashed #aaa; }
        #guest-list { list-style: none; padding-left: 0; text-align: left;}
        #guest-list li { padding: 3px; border-bottom: 1px solid #eee; }
        #guest-list li:last-child { border-bottom: none; }

        @media (max-width: 600px) { /* ... */ }
        @media (max-width: 400px) { /* ... */ }
    </style>
</head>
<body>

    <h1>Белот Русе P2P (Демо v7.0)</h1>

    <div class="connection-setup">
        <h2>Мултиплейър за 4 Играча</h2>
        <div id="role-selection">
            <input type="text" id="player-name-input" placeholder="Вашето име" value="Играч">
            <button id="become-host-btn">Аз съм Хост</button>
            <button id="become-guest-btn">Аз съм Гост</button>
        </div>

        <div id="host-panel" style="display:none;">
            <h3>Вие сте Хост</h3>
            <p>Споделете този Код на Стаята (Вашият Peer ID) с другите 3 играча:</p>
            <p>
                <strong id="host-peer-id-display" style="font-size: 1.2em; background: #eee; padding: 5px;">Зареждане...</strong>
                <button id="copy-host-id-btn" style="margin-left: 10px;">Копирай</button>
            </p>
            <p>Свързани гости: <span id="connected-guests-count">0</span>/3</p>
            <h4>Списък на гостите:</h4>
            <ul id="guest-list"></ul>
            <button id="mp-start-game-btn" disabled>Старт на Играта (Нужни са 3 госта)</button>
        </div>

        <div id="guest-panel" style="display:none;">
            <h3>Вие сте Гост</h3>
            <p>Въведете Кода на Стаята (Peer ID на Хоста):</p>
            <input type="text" id="host-id-input" placeholder="Код от Хоста">
            <button id="connect-to-host-btn">Свържи се с Хоста</button>
        </div>
        <div id="mp-connection-status" style="margin-top:10px; font-weight: bold;">Статус: Изберете роля.</div>
    </div>


    <div class="game-container" style="display:none;"> <!-- Скриваме играта първоначално -->
         <div id="persistent-trump-info" class="persistent-trump">Коз: N/A</div>
         <div id="player-area-N" class="player-area player-north"><div class="player-name">Север</div><div class="hand" id="hand-N"></div></div>
         <div id="player-area-E" class="player-area player-east"><div class="player-name">Изток</div><div class="hand" id="hand-E"></div></div>
         <div id="player-area-S" class="player-area player-south"><div class="hand" id="hand-S"></div><div class="player-name">Юг (Вие)</div></div>
         <div id="player-area-W" class="player-area player-west"><div class="player-name">Запад</div><div class="hand" id="hand-W"></div></div>
         <div class="trick-area" id="trick-area"> <div id="trick-slot-S" class="trick-card-slot player-S"></div> <div id="trick-slot-W" class="trick-card-slot player-W"></div> <div id="trick-slot-N" class="trick-card-slot player-N"></div> <div id="trick-slot-E" class="trick-card-slot player-E"></div> </div>
         <div class="controls-area" id="controls-area"> <p>Вашият ход:</p> <div id="controls-buttons"></div> </div>
    </div>

    <div class="announcements" id="declared-announcements-display" style="display:none;"> <p>Обявени Анонси:</p> <div id="declared-announcements-list">Няма обявени анонси в този рунд.</div> </div>
    <div class="messages" id="messages">Изберете роля, за да започнете.</div>
    <div class="score-board" id="score-board" style="display:none;">Резултат: Ние: 0 - Те: 0</div>
    <!-- Премахваме бутона за локална игра, за да се фокусираме върху мултиплейър -->
    <!-- <div style="margin-top: 10px;"> <button id="start-game-btn">Старт Локална Игра</button> </div> -->
    <div id="announcementModal" class="modal"> <div class="modal-content"> <h3>Обявете вашите анонси (първа ръка):</h3> <div id="modal-announcement-list" class="modal-announcement-list"></div> <button id="modal-confirm-btn" class="modal-close-btn">Потвърди и играй</button> </div> </div>

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script>
        // --- Константи и Глобални Променливи ---
        const SUITS = { SPADES: '♠', HEARTS: '♥', DIAMONDS: '♦', CLUBS: '♣' };
        const SUIT_KEYS = Object.keys(SUITS);
        const RANKS = ['7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
        const PLAYERS = ['S', 'W', 'N', 'E']; // Юг, Запад, Север, Изток
        const POINTS_NO_TRUMP = { '7': 0, '8': 0, '9': 0, '10': 10, 'J': 2, 'Q': 3, 'K': 4, 'A': 11 };
        const POINTS_TRUMP    = { '7': 0, '8': 0, '9': 14, '10': 10, 'J': 20, 'Q': 3, 'K': 4, 'A': 11 };
        const RANK_ORDER_FOR_SEQ = ['7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
        const ANNOUNCEMENTS_DEF = {
            'BELOT':   { value: 10, points: 20, name: "Белот" },
            'TERCA':   { value: 20, points: 20, name: "Терца", rankValue: -1 },
            'QUARTA':  { value: 30, points: 50, name: "Кварта", rankValue: -1 },
            'QUINTA':  { value: 40, points: 100, name: "Квинта", rankValue: -1 },
            'SQ_7':    { value: 15, points: 0, name: "4x7", rankValue: RANK_ORDER_FOR_SEQ.indexOf('7') },
            'SQ_8':    { value: 15, points: 0, name: "4x8", rankValue: RANK_ORDER_FOR_SEQ.indexOf('8') },
            'SQ_9':    { value: 15, points: 0, name: "4x9", rankValue: RANK_ORDER_FOR_SEQ.indexOf('9') },
            'SQ_10':   { value: 50, points: 100, name: "4x10", rankValue: RANK_ORDER_FOR_SEQ.indexOf('10') },
            'SQ_Q':    { value: 50, points: 100, name: "4xQ", rankValue: RANK_ORDER_FOR_SEQ.indexOf('Q') },
            'SQ_K':    { value: 50, points: 100, name: "4xK", rankValue: RANK_ORDER_FOR_SEQ.indexOf('K') },
            'SQ_A':    { value: 60, points: 150, name: "4xA", rankValue: RANK_ORDER_FOR_SEQ.indexOf('A') },
            'SQ_J':    { value: 70, points: 200, name: "4xJ", rankValue: RANK_ORDER_FOR_SEQ.indexOf('J') },
            'SQ_10_NT':{ value: 75, points: 200, name: "4x10 (Без Коз)", rankValue: RANK_ORDER_FOR_SEQ.indexOf('10') },
            'SQ_A_NT': { value: 80, points: 400, name: "4xA (Без Коз)", rankValue: RANK_ORDER_FOR_SEQ.indexOf('A') },
        };
        const BIDS = ['PASS', 'CLUBS', 'DIAMONDS', 'HEARTS', 'SPADES', 'NO_TRUMP', 'ALL_TRUMP'];
        const BID_NAMES = {
            'PASS': 'Пас', 'CLUBS': '♣ Спатия', 'DIAMONDS': '♦ Каро', 'HEARTS': '♥ Купа',
            'SPADES': '♠ Пика', 'NO_TRUMP': 'Без Коз', 'ALL_TRUMP': 'Всичко Коз'
        };

        let deck = [];
        let hands = { 'S': [], 'W': [], 'N': [], 'E': [] };
        let currentDealer = 'S'; // Ще се определи от хоста
        let currentPlayer = '';
        let gameState = 'INIT'; // INIT, LOBBY, DEALING, BIDDING, PLAYING, SCORING_TRICK, END_ROUND, GAME_OVER
        let currentBid = { player: null, bid: 'PASS', level: -1 };
        let biddingHistory = [];
        let trumpSuit = null;
        let currentTrick = [];
        let trickHistory = [];
        let teamScores = { 'NS': 0, 'EW': 0 };
        let roundScores = { 'NS': { points: 0, announcements: 0 }, 'EW': { points: 0, announcements: 0 } };
        let potentialAnnouncements = { 'S': [], 'W': [], 'N': [], 'E': [] };
        let declaredAnnouncements = { 'S': [], 'W': [], 'N': [], 'E': [] };
        let playerDeclaredFlags = { 'S': false, 'W': false, 'N': false, 'E': false };
        let belotStatus = { S:{hasKQ:!1,declared:!1},W:{hasKQ:!1,declared:!1},N:{hasKQ:!1,declared:!1},E:{hasKQ:!1,declared:!1} };
        let myPosition = null; // Коя позиция съм аз (S, W, N, E)

        // --- Мултиплейър Променливи ---
        let peer;
        let myPeerId = null;
        let isHost = false;
        let gameMode = 'INIT_MP'; // INIT_MP, MULTIPLAYER_HOST, MULTIPLAYER_GUEST, LOCAL
        let guestConnections = {}; // За хоста: { 'guestPeerId1': conn1, ... }
        let hostConnection = null;  // За госта: връзката към хоста
        let connectedGuestsCount = 0;
        let playerNames = {}; // { 'S': 'Име', 'W': 'Име', ... } (ще използваме позициите като ключ)
        let playerPeerIds = {}; // { 'S': 'peerId', 'W': 'peerId', ... } (позиция към peerId)


        // --- DOM Елементи ---
        let persistentTrumpInfoEl, playerAreaEls, playerHands, trickAreaEl, trickCardSlots,
            controlsAreaEl, controlsButtonsEl, declaredAnnouncementsDisplayEl,
            declaredAnnouncementsListEl, messagesEl, scoreBoardEl,
            announcementModal, modalAnnouncementsList, modalConfirmBtn,
            // Мултиплейър UI
            roleSelectionEl, playerNameInputEl, becomeHostBtnEl, becomeGuestBtnEl,
            hostPanelEl, hostPeerIdDisplayEl, copyHostIdBtnEl, connectedGuestsCountEl, guestListEl, mpStartGameBtnEl,
            guestPanelEl, hostIdInputEl, connectToHostBtnEl,
            mpConnectionStatusEl, gameContainerEl; // Добавяме gameContainerEl

        // --- Помощни UI Функции (същите като преди, но с проверки за null) ---
        // ... (всички UI функции: setMessage, updateScoreBoard, renderCard, renderHand и т.н.) ...
        // --- Всички останали функции на играта (createDeck, dealInitialCards, startGame и т.н.) ---
        // --- Включително коригираните isPlayable, findCurrentTrickWinnerHypothetical, endRound ---
        // --- Включително НОВИТЕ МУЛТИПЛЕЙЪР ФУНКЦИИ: ---
        // --- initializeMultiplayerElements, setupHostPeerJS, setupGuestPeerJS, connectToHost, ---
        // --- setupPeerDataEvents, broadcastToGuests, sendToHost, assignPlayerPositionsAndStart, ---
        // --- sendGameDataToSpecificGuest, handleNetworkMessage ---


        // --- Пълният JavaScript код от предишния отговор (v7.0), ---
        // --- започвайки от "function setMessage(msg) { ... }" ---
        // --- и завършвайки точно преди последния `document.addEventListener('DOMContentLoaded', ...)` ---

        // --- ТУК ПОСТАВИ ЦЕЛИЯ JAVASCRIPT БЛОК ОТ ПРЕДИШНИЯ ОТГОВОР, ---
        // --- КАТО ЗАПОЧНЕМ ОТ: function setMessage(msg) { ... } ---
        // --- И ЗАВЪРШИМ ТОЧНО ПРЕДИ: document.addEventListener('DOMContentLoaded', () => { ... }); ---

        // --- Event Listeners и Първоначално състояние ---
         document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM fully loaded and parsed (v7.0 - 4 Players)");

            // Присвояване на DOM елементите...
            persistentTrumpInfoEl = document.getElementById('persistent-trump-info');
            playerAreaEls = { S: document.getElementById('player-area-S'), W: document.getElementById('player-area-W'), N: document.getElementById('player-area-N'), E: document.getElementById('player-area-E') };
            playerHands = { S: document.getElementById('hand-S'), W: document.getElementById('hand-W'), N: document.getElementById('hand-N'), E: document.getElementById('hand-E') };
            trickAreaEl = document.getElementById('trick-area');
            trickCardSlots = { S: document.getElementById('trick-slot-S'), W: document.getElementById('trick-slot-W'), N: document.getElementById('trick-slot-N'), E: document.getElementById('trick-slot-E') };
            controlsAreaEl = document.getElementById('controls-area');
            controlsButtonsEl = document.getElementById('controls-buttons');
            declaredAnnouncementsDisplayEl = document.getElementById('declared-announcements-display');
            declaredAnnouncementsListEl = document.getElementById('declared-announcements-list');
            messagesEl = document.getElementById('messages');
            scoreBoardEl = document.getElementById('score-board');
            // startGameBtn е премахнат, използваме mpStartGameBtnEl
            announcementModal = document.getElementById('announcementModal');
            modalAnnouncementsList = document.getElementById('modal-announcement-list');
            modalConfirmBtn = document.getElementById('modal-confirm-btn');
            gameContainerEl = document.querySelector('.game-container');


            initializeMultiplayerElements(); // Инициализираме новите UI елементи за мултиплейър

            console.log("DOM elements assigned.");

            // Проверка за критични елементи...
             if (!messagesEl || !gameContainerEl /* ... добави и другите важни ... */ ) {
                 console.error("One or more critical DOM elements were not found!");
                 const body = document.querySelector('body');
                 if(body) {
                    const errorDiv = document.createElement('div');
                    errorDiv.style.color = 'red'; errorDiv.style.padding = '20px'; errorDiv.style.fontSize = '20px';
                    errorDiv.textContent = "Грешка при зареждане на основните елементи на страницата! Проверете конзолата (F12).";
                    body.prepend(errorDiv);
                 }
                 return;
             }

            // Първоначално състояние
            setMessage("Изберете роля (Хост/Гост), за да започнете мултиплейър игра.");
            updateScoreBoard();
            renderAllHands(); // Ще покаже празни полета
            clearCurrentPlayerHighlight();
            updatePersistentTrumpInfo();
            hideBiddingControls();
            if(declaredAnnouncementsDisplayEl) declaredAnnouncementsDisplayEl.style.display = 'none'; // Скриваме първоначално
            if(scoreBoardEl) scoreBoardEl.style.display = 'none'; // Скриваме първоначално
            if(gameContainerEl) gameContainerEl.style.display = 'none'; // Скриваме играта първоначално


            console.log("Initial setup complete.");
        });

    </script>

</body>
</html>